name: Build Minimal FFmpeg Kit Android
on:
  workflow_dispatch:
jobs:
  build-ffmpeg-android:
    name: Build FFmpeg Android (NDK r25b)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout ffmpeg-kit
        uses: actions/checkout@v4
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            build-essential \
            cmake \
            git \
            libtool \
            pkg-config \
            texinfo \
            yasm \
            nasm \
            gettext \
            autopoint \
            gperf \
            libssl-dev \
            bison \
            flex \
            groff \
            curl \
            unzip
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Clean Android SDK CMake
        run: |
          # The original workflow removes these specific versions to avoid conflicts
          # with system cmake or internal build script logic.
          if [ -d "$ANDROID_HOME/cmdline-tools/latest/bin" ]; then
            $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --uninstall "cmake;3.10.2.4988404" "cmake;3.18.1"
          fi
      - name: Setup Android NDK r25b
        run: |
          # Download NDK r25b specifically as recommended by the compatibility note
          echo "Downloading NDK r25b..."
          curl -s "https://dl.google.com/android/repository/android-ndk-r25b-linux.zip" -o ndk.zip
          
          echo "Unzipping NDK..."
          unzip -q -o ndk.zip -d .ndk
          
          # Set Evironment Variables exactly as the original workflow
          NDK_PATH=$(pwd)/.ndk/android-ndk-r25b
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          
          echo "NDK Setup complete at $NDK_PATH"
      - name: Build Custom FFmpeg
        run: |
          # Ensure scripts are executable
          chmod +x android.sh
          
          # Force 16KB alignment 
          export LDFLAGS="-Wl,-z,max-page-size=16384"
          
          # Build command
          # Using options similar to original but with our minimal goal
          # --no-archive: Don't zip sources (saves time)
          # --lts: Use LTS support (often more stable)
          # --disable-arm-v7a: If you want to speed it up and don't need 32-bit (optional)
          
          ./android.sh --no-archive --lts
          
      - name: Upload AAR
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ffmpeg-kit-minimal.aar
          path: bundle-android-aar/*.aar
